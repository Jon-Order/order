<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .navbar {
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        .card {
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,.05);
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .status-badge {
            font-size: 0.85rem;
            padding: 0.35rem 0.65rem;
        }
        .status-pending {
            background-color: #ffd43b;
            color: #000;
        }
        .status-sent {
            background-color: #51cf66;
            color: #fff;
        }
        .timestamp {
            font-size: 0.85rem;
            color: #6c757d;
        }
        .order-details {
            font-size: 0.9rem;
        }
        #searchInput {
            border-radius: 20px;
            padding-left: 1rem;
            padding-right: 1rem;
        }
        .refresh-btn {
            border-radius: 20px;
        }
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img id="logo" src="/new-logo.png" alt="ORDER Logo" style="height: 40px; margin-right: 10px;" />
                ORDER
            </a>
            <div class="d-flex">
                <button class="btn btn-outline-primary refresh-btn" onclick="loadOrders()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-md-6">
                <input type="text" id="searchInput" class="form-control" placeholder="Search orders...">
            </div>
            <div class="col-md-6">
                <div class="d-flex justify-content-end">
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary active" data-filter="all">All</button>
                        <button class="btn btn-outline-secondary" data-filter="pending">Pending</button>
                        <button class="btn btn-outline-secondary" data-filter="sent">Sent</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="ordersContainer" class="row g-4">
            <!-- Orders will be dynamically inserted here -->
        </div>
    </div>

    <div class="loading" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Add a link/button to open the DB Browser in a new page -->
    <h2>Admin Tools</h2>
    <a href="/db-browser.html" target="_blank" style="display:inline-block;padding:10px 20px;background:#007bff;color:#fff;text-decoration:none;border-radius:5px;margin:10px 0;">Open Database Browser</a>

    <!-- Modal HTML -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-labelledby="orderDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderDetailModalLabel">Order Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="orderDetailBody">
                    <!-- Details will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let orders = [];
        let locationMap = {};
        let supplierMap = {};
        let userMap = {};
        let locationBrandMap = {};

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date)) return dateString;
            // Format as dd/mm/yyyy
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function createOrderCard(order) {
            const locationBrand = locationBrandMap[order.location_id] || locationMap[order.location_id] || order.location_id;
            const supplierName = supplierMap[order.supplier_id] || order.supplier_id;
            const userName = userMap[order.created_by] || order.created_by;
            return `
                <div class="col-md-6 col-lg-4 order-card" data-status="${order.status ? order.status.toLowerCase() : 'unknown'}">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">${order.id}</h5>
                                <span class="badge status-badge status-${order.status ? order.status.toLowerCase() : 'unknown'}">${order.status || 'Unknown'}</span>
                            </div>
                            <div class="order-details">
                                <p class="mb-1 fw-bold">${locationBrand}</p>
                                <p class="mb-1"><i class="bi bi-truck me-2"></i>${supplierName}</p>
                                <p class="mb-1"><i class="bi bi-calendar me-2"></i>${formatDate(order.order_date)}</p>
                                <p class="mb-1"><i class="bi bi-person me-2"></i>${userName}</p>
                            </div>
                            <div class="mt-3">
                                <small class="timestamp"><i class="bi bi-clock me-1"></i>${formatDate(order.created_at || order.order_date)}</small>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent">
                            <div class="d-flex justify-content-end">
                                <button class="btn btn-sm btn-outline-secondary" onclick="viewDetails('${order.id}')">
                                    <i class="bi bi-info-circle me-1"></i>Details
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function filterOrders(status = 'all') {
            const cards = document.querySelectorAll('.order-card');
            cards.forEach(card => {
                if (status === 'all' || card.dataset.status === status) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function searchOrders(query) {
            const cards = document.querySelectorAll('.order-card');
            cards.forEach(card => {
                const cardText = card.textContent.toLowerCase();
                if (cardText.includes(query.toLowerCase())) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        async function fetchReferenceData() {
            // Fetch all locations, suppliers, users, and locations-with-brand in parallel
            const [locRes, supRes, userRes, locBrandRes] = await Promise.all([
                fetch('/api/locations'),
                fetch('/api/suppliers'),
                fetch('/api/users'),
                fetch('/api/locations-with-brand')
            ]);
            const [locData, supData, userData, locBrandData] = await Promise.all([
                locRes.json(),
                supRes.json(),
                userRes.json(),
                locBrandRes.json()
            ]);
            locationMap = {};
            supplierMap = {};
            userMap = {};
            locationBrandMap = {};
            if (locData.success) locData.data.forEach(l => locationMap[l.id] = l.name);
            if (supData.success) supData.data.forEach(s => supplierMap[s.id] = s.name);
            if (userData.success) userData.data.forEach(u => userMap[u.id] = u.name);
            if (locBrandData.success) locBrandData.data.forEach(l => locationBrandMap[l.id] = `${l.brand_name || ''} - ${l.name}`.replace(/^ - /, ''));
        }

        async function loadOrders() {
            const spinner = document.getElementById('loadingSpinner');
            const container = document.getElementById('ordersContainer');
            try {
                spinner.style.display = 'block';
                // Fetch reference data before orders
                await fetchReferenceData();
                const response = await fetch('/admin/orders');
                const data = await response.json();
                if (data.success) {
                    orders = data.orders;
                    container.innerHTML = orders.map(createOrderCard).join('');
                } else {
                    container.innerHTML = '<div class="col"><div class="alert alert-danger">Failed to load orders</div></div>';
                }
            } catch (error) {
                container.innerHTML = '<div class="col"><div class="alert alert-danger">Error loading orders</div></div>';
            } finally {
                spinner.style.display = 'none';
            }
        }

        async function viewDetails(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;
            // Fetch order lines
            const linesRes = await fetch(`/api/orders/${orderId}/lines`);
            const linesData = await linesRes.json();
            const orderLines = linesData.success ? linesData.data : [];
            // Build order lines table
            let linesTable = `<div class="mt-4"><h4>Order Lines</h4><div class="table-responsive"><table class="table table-bordered"><thead><tr><th>QUANTITY</th><th>UNIT</th><th>ITEM</th><th>PRODUCT CODE</th></tr></thead><tbody>`;
            if (orderLines.length) {
                orderLines.forEach(line => {
                    linesTable += `<tr><td>${line.quantity}</td><td>${line.unit || ''}</td><td>${line.product_name || ''}</td><td>${line.product_code || ''}</td></tr>`;
                });
            } else {
                linesTable += `<tr><td colspan="4" class="text-center">No order lines found</td></tr>`;
            }
            linesTable += `</tbody></table></div></div>`;
            // Build order details
            const locationBrand = locationBrandMap[order.location_id] || locationMap[order.location_id] || order.location_id;
            const supplierName = supplierMap[order.supplier_id] || order.supplier_id;
            const userName = userMap[order.created_by] || order.created_by;
            const detailsHtml = `
                <div><strong>Order ID:</strong> ${order.id}</div>
                <div><strong>Status:</strong> ${order.status || 'Unknown'}</div>
                <div><strong>Date:</strong> ${formatDate(order.order_date)}</div>
                <div><strong>Location:</strong> ${locationBrand}</div>
                <div><strong>Supplier:</strong> ${supplierName}</div>
                <div><strong>Created By:</strong> ${userName}</div>
                ${linesTable}
            `;
            document.getElementById('orderDetailBody').innerHTML = detailsHtml;
            const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
            modal.show();
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            loadOrders();

            // Filter buttons
            document.querySelectorAll('[data-filter]').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelectorAll('[data-filter]').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    filterOrders(e.target.dataset.filter);
                });
            });

            // Search input
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                searchOrders(e.target.value);
            });
        });

        // Auto-refresh every 30 seconds
        setInterval(loadOrders, 30000);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 